<div class="toolbox">

  <mat-card appearance="outlined">
    <mat-card-header>
      {{this.numConcepts}} concepts
      @if (conceptsFilter()) {
      ({{table().filteredConcepts.length}} filtered)
      }
    </mat-card-header>
    <mat-card-content matTooltip="Enter a string to filter the concepts displayed in the table by concept name or tag.">
      <p>
        <mat-form-field class="dense concepts-filter">
          <input matInput [(ngModel)]="conceptsFilter" placeholder="Filter">
          <button mat-icon-button matSuffix (click)="conceptsFilter.set('')">
            <mat-icon>backspace</mat-icon>
          </button>
        </mat-form-field>
      </p>
    </mat-card-content>
  </mat-card>

  <mat-card appearance="outlined">
    <mat-card-header
      matTooltip="A maximum of {{PAGE_SIZE}} concepts is displayed in one page. Use the buttons to navigate to other pages when there are more.">
      Page {{pagesInfo}}
    </mat-card-header>
    <mat-card-content>
      <mat-paginator #paginator (page)="setPageInfo($event)" [hidePageSize]="true" [pageSizeOptions]="[PAGE_SIZE]"
        showFirstLastButtons></mat-paginator>
    </mat-card-content>
  </mat-card>

  <mat-card appearance="outlined">
    <mat-card-header matTooltip="Modify the selected concepts.">
      Modify {{table().selectedFiltered().length}} concept{{table().selectedFiltered().length == 1 ? '' : 's'}}
    </mat-card-header>
    <mat-card-actions>
      <span matTooltip="Set the tag of all codes associated to the selected concepts.">
        <button mat-stroked-button (click)="showTagsDialog(table().selectedFiltered())"
          [disabled]="!hasSelectedConcepts() || !userCanEdit">Tag codes</button>
      </span>
      <button mat-stroked-button (click)="delete(table().selectedFiltered())"
        [disabled]="!hasSelectedConcepts() || !userCanEdit" color="warn">Delete</button>
    </mat-card-actions>
  </mat-card>

  <mat-card appearance="outlined">
    <mat-card-header matTooltip="Expand a concept to related concepts. Operates on a single selected concept.">
      Expand concept
    </mat-card-header>
    <mat-card-actions>
      <button matTooltip="Expand to concepts that are broader than the selected concept."
        (click)="broaderConcepts(table().selectedFiltered()[0], vocIds())"
        [disabled]="table().selectedFiltered().length != 1 || !userCanEdit" mat-stroked-button>
        Broader
      </button>
      <button matTooltip="Expand to concepts that are narrower than the selected concept"
        (click)="narrowerConcepts(table().selectedFiltered()[0], vocIds())"
        [disabled]="table().selectedFiltered().length != 1 || !userCanEdit" mat-stroked-button>
        Narrower
      </button>
    </mat-card-actions>
  </mat-card>

  <mat-card appearance="outlined">
    <mat-card-header
      matTooltip="Search and add concepts by CUI, code or term. Concepts that match a CUI or code are shown in dropdown, optionally with vocabulary as prefix (e.g., ICD9:780). Use the search button to retrieve all concepts that mention the query text.">
      Search concepts
    </mat-card-header>
    <mat-card-actions class="dense">
      <mat-form-field>
        <input #query matInput type="text" placeholder="Code or concept query" [readonly]="!userCanEdit"
          [formControl]="codeSearchQueryControl" [matAutocomplete]="auto">
        <mat-autocomplete #auto="matAutocomplete">
          @for (option of codeConcepts; track option) {
          <mat-option (click)="selectAutocompleteCode(option, query.value)">
            {{option.name}}
          </mat-option>
          }
        </mat-autocomplete>
      </mat-form-field>
      <button (click)="searchAddConcepts(query.value, state().mapping.meta)" [disabled]="!userCanEdit"
        mat-stroked-button matTooltip="Search concepts by query">Search</button>
    </mat-card-actions>
  </mat-card>

  <mat-card appearance="outlined">
    <mat-card-header>
      Import
    </mat-card-header>
    <mat-card-actions class="dense" matTooltip="Import codes from CSV file (only without unsaved changes)">
      <button (click)="openDialog(addCodesCsv)" [disabled]="!userCanEdit || state().stacks.hasUndo()"
        mat-stroked-button>
        Code list
      </button>
      <button (click)="openDialog(indexer)" [disabled]="!userCanEdit" mat-stroked-button
        matTooltip="Search concepts in free text">
        Free&#8209;text
      </button>
    </mat-card-actions>
  </mat-card>
</div>
<concepts-table #conceptsTable [showCodeTagIndication]="true" [conceptTags]="state().caches.conceptTags"
  [concepts]="state().mapping.concepts" [filter]="conceptsFilter()" [codes]="state().mapping.codes"
  [vocabularies]="vocIds()" [allTopics]="allTopics" [userCanEdit]="userCanEdit" (reviewRun)="reviewRun.emit($event)"
  [paginator]="paginator">
</concepts-table>

<ng-template #indexer>
  <h2 matDialogTitle>Search and add concepts from free-text</h2>
  <mat-dialog-content>
    <indexer [vocIds]="vocIds()" [typesInfo]="state().mapping.meta"
      (confirmedIndexing)="addIndexing($event); dialogRef!.close()" confirmLabel="Add selected concepts"></indexer>
  </mat-dialog-content>
  <mat-dialog-actions>
    <button mat-button matDialogClose>Cancel</button>
  </mat-dialog-actions>
</ng-template>

<ng-template #addCodesCsv>
  <div class="title">
    <h2 mat-dialog-title>
      Import code list
    </h2>
    <button mat-icon-button mat-dialog-close><mat-icon>close</mat-icon></button>
  </div>
  <mat-dialog-content>
    <p>The code list must be a CSV file with the following columns: <code>coding_system</code>,
      <code>code</code>, <code>tags</code>.
    </p>
    <p>
      <input class="mapping-file" #csvFileInput type="file" style="height:0;width:0;overflow:hidden;visibility:hidden;"
        (change)="handleCsvFileInput($event)" accept="text/csv">
      <button (click)="csvFileInput.click()" mat-raised-button>
        Select CSV file
      </button>
      @if (csvImportFile) {
      <span>&nbsp;{{csvImportFile.name}}</span>
      }
      <!-- <p>Review comments can be
      included using columns
      <code>review1_author</code>,
      <code>review1_timestamp</code>, <code>review1_content</code>, <code>...</code>
      with consecutive numbers for multiple rounds of review.
    </p> -->
    <p>
      <mat-checkbox #filter [checked]="true">Filter by columns <code>event_abbreviation</code>,
        <code>type</code>,
        <code>system</code>.</mat-checkbox>
    </p>
    <p>
      <button class="mapping-import" [disabled]="csvImportFile == null" mat-dialog-close
        (click)="importCsv(csvImportFile!, filter.checked, 'csv_compat')" color="primary" mat-raised-button>Ok</button>
    </p>
  </mat-dialog-content>
</ng-template>