<menu-banner [projectName]="info.projectName" omitSpacer="true">
  <span matTooltip="{{titleTooltip()}}">
    <!-- <mat-icon>schema</mat-icon> -->
    <button routerLink="/folder/{{info.projectName}}" class="project-link" mat-button>{{info.projectName}}:</button>
    @if (info) {
      <span><span class="name" (click)="dump()">{{info.meta.definition ?? info.mappingName}}</span>@if (saveRequired) {
      <span
      >*</span>
      }@if (info.meta.system || info.meta.type) {
      <span> ({{shortMeta()}})</span>
    }</span>
  }
</span>
@if (error) {
  <mat-error>&nbsp;Error: {{error}}</mat-error>
}
@if (state != null) {
  <ng-container onTheRight>
    <span matTooltip="{{state.stacks.undoTooltip()}}">
      <button (click)="undo()" [disabled]="!state.stacks.canUndo()" mat-icon-button>
        <mat-icon>undo</mat-icon>
      </button></span>
      <span matTooltip="{{state.stacks.redoTooltip()}}">
        <button (click)="redo()" [disabled]="!state.stacks.canRedo()" mat-icon-button>
          <mat-icon>redo</mat-icon>
        </button></span>
        <span matTooltip="{{state.stacks.hasUndo() ? 'Save changes' : 'No changes'}}">
          <button class="tool-mapping-save" (click)="openDialog(saveDialog)"
            [disabled]="(info == null || info.status != 'IMPORTED') && (state.mapping.start == null || (!saveRequired && !state.stacks.hasUndo()) || !(projectRole == 'Owner' || projectRole == 'Editor'))"
            mat-icon-button>
            <mat-icon>save@if (saveRequired) {
              <span>*</span>
            }</mat-icon>
          </button>
        </span>
        <span matTooltip="Export codelist of the current revision">
          <button [disabled]="!userCanDownload || saveRequired || state.stacks.hasUndo()" (click)="openDownloadDialog()"
            mat-icon-button>
            <mat-icon>download</mat-icon>
          </button>
        </span>
      </ng-container>
    }
  </menu-banner>

  @if (initial) {
    <div class="center-content spaced">
      <start-mapping (start)="setStart($event)" [vocIds]="serverInfo.defaultVocabularies"
      [mappingInfo]="info" [serverInfo]="serverInfo"></start-mapping>
    </div>
  }

  @if (state) {
    <mat-tab-group [selectedIndex]="selectedIndex">
      <mat-tab label="Mapping">
        @if (state.mapping.start != null && info.meta != null) {
          <div>
            <mapping-tab [projectName]="info.projectName" [shortkey]="shortkey" [latest]="latest" [info]="info!"
              [state]="state" [serverInfo]="serverInfo" [revisions]="revisions" [vocabularies]="vocabularies"
              [userCanDownload]="userCanDownload && !!shortkey && !saveRequired && !state.stacks.hasUndo()"
            [userCanEdit]="userCanEdit" [projectRole]="projectRole" (run)="run($event)"></mapping-tab>
          </div>
        }
      </mat-tab>
      <mat-tab label="Concepts" [disabled]="state.mapping.start == null">
        @if (!state.mapping.isEmpty()) {
          <concepts [state]="state" [serverInfo]="serverInfo" [info]="info"
            [allTopics]="allTopics" [vocabularies]="vocabularies" [userCanEdit]="userCanEdit" (run)="run($event)"
          (reviewRun)="reviewRun($event)"></concepts>
        }
      </mat-tab>
      <mat-tab label="Codes" [disabled]="state.mapping.start == null">
        @if (!state.mapping.isEmpty() && state.mapping.numVocabularies() > 0) {
          <codes [state]="state"
          [allTopics]="allTopics" [userCanEdit]="userCanEdit" (run)="run($event)" (reviewRun)="reviewRun($event)"></codes>
        }
      </mat-tab>
      <mat-tab label="Coding systems" [disabled]="state.mapping.start == null">
        @if (!state.mapping.isEmpty()) {
          <vocabularies [userCanEdit]="userCanEdit" [mapping]="state.mapping" (run)="run($event)">
          </vocabularies>
        }
      </mat-tab>
    </mat-tab-group>
  }

  <ng-template #saveDialog>
    <h2 matDialogTitle>Save mapping</h2>
    <mat-dialog-content>
      <mat-form-field style="width:100%;">
        <mat-label>Summary</mat-label>
        <textarea class="save-summary" rows="5" cols="30" #summary matInput></textarea>
      </mat-form-field>
      Modifications
      <ol>
        @for (step of state?.stacks?.undoStack; track step) {
          <li>
            {{step.description}}
          </li>
        }
      </ol>
    </mat-dialog-content>
    <mat-dialog-actions align="end">
      <button mat-button matDialogClose>Cancel</button>
      <button class="mapping-save" mat-raised-button [disabled]="!summary.value" (click)="save(summary.value)"
      matDialogClose color="primary">Save</button>
    </mat-dialog-actions>
  </ng-template>